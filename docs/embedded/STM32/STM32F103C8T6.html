<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-embedded/STM32/STM32F103C8T6" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">STM32F103C8T6 | 我的网站</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://eurekashadow.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://eurekashadow.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://eurekashadow.github.io/docs/embedded/STM32/STM32F103C8T6"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="STM32F103C8T6 | 我的网站"><meta data-rh="true" name="description" content="这里有STM32F103C8T6相关的内容！"><meta data-rh="true" property="og:description" content="这里有STM32F103C8T6相关的内容！"><link data-rh="true" rel="icon" href="/img/Eureka.ico"><link data-rh="true" rel="canonical" href="https://eurekashadow.github.io/docs/embedded/STM32/STM32F103C8T6"><link data-rh="true" rel="alternate" href="https://eurekashadow.github.io/docs/embedded/STM32/STM32F103C8T6" hreflang="zh"><link data-rh="true" rel="alternate" href="https://eurekashadow.github.io/en/docs/embedded/STM32/STM32F103C8T6" hreflang="en"><link data-rh="true" rel="alternate" href="https://eurekashadow.github.io/docs/embedded/STM32/STM32F103C8T6" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://AFEW9ZLEC6-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"嵌入式相关","item":"https://eurekashadow.github.io/docs/category/嵌入式相关"},{"@type":"ListItem","position":2,"name":"STM32F103C8T6","item":"https://eurekashadow.github.io/docs/embedded/STM32/STM32F103C8T6"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="我的网站 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="我的网站 Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="我的网站" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.2c6c1e69.css">
<script src="/assets/js/runtime~main.f31671fb.js" defer="defer"></script>
<script src="/assets/js/main.2bcccb39.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/Eureka.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Eureka.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/Eureka.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">我的网站</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/reflection-space">记录</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文</a><ul class="dropdown__menu"><li><a href="/docs/embedded/STM32/STM32F103C8T6" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh">中文</a></li><li><a href="/en/docs/embedded/STM32/STM32F103C8T6" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/EurekaShadow/EurekaShadow.github.io/tree/master" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/reflection-space">回想空间</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Links">常用链接</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/Issues">遇到的问题</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/我的项目">我的项目</a><button aria-label="展开侧边栏分类 &#x27;我的项目&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/嵌入式相关">嵌入式相关</a><button aria-label="折叠侧边栏分类 &#x27;嵌入式相关&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/embedded/STM32/STM32F103C8T6">STM32</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/embedded/STM32/STM32F103C8T6">STM32F103C8T6</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/embedded/博客相关/embedded-resources">博客相关</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/模板">模板</a><button aria-label="展开侧边栏分类 &#x27;模板&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/example">example</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/嵌入式相关"><span>嵌入式相关</span></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">STM32</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">STM32F103C8T6</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>STM32F103C8T6</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h2>
<p>记录学习STM32F103C8T6中遇到的某些概念的理解，问题的排查思路解决方法，总结等。内容上可能是个大杂烩。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概念理解">概念理解<a href="#概念理解" class="hash-link" aria-label="概念理解的直接链接" title="概念理解的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mcu-内存结构与变量存储详解">MCU 内存结构与变量存储详解<a href="#mcu-内存结构与变量存储详解" class="hash-link" aria-label="MCU 内存结构与变量存储详解的直接链接" title="MCU 内存结构与变量存储详解的直接链接">​</a></h3>
<blockquote>
<p>——以 STM32F103C8T6 为例</p>
</blockquote>
<p>以 <strong>STM32F103C8T6（Cortex-M3，72MHz，20KB RAM，64KB Flash）</strong> 为例，系统性地梳理 MCU 的内存结构和变量存储规则。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rom-vs-ram本质区别">ROM vs RAM：本质区别<a href="#rom-vs-ram本质区别" class="hash-link" aria-label="ROM vs RAM：本质区别的直接链接" title="ROM vs RAM：本质区别的直接链接">​</a></h4>
<table><thead><tr><th>特性</th><th>ROM（Flash）</th><th>RAM（SRAM）</th></tr></thead><tbody><tr><td><strong>全称</strong></td><td>Read-Only Memory（只读存储器）</td><td>Random Access Memory（随机存取存储器）</td></tr><tr><td><strong>物理特性</strong></td><td>非易失性（断电不丢数据）</td><td>易失性（断电清零）</td></tr><tr><td><strong>用途</strong></td><td>存放程序代码 + 常量数据</td><td>存放运行时变量 + 栈 + 堆</td></tr><tr><td><strong>读写速度</strong></td><td>较慢（需 flash controller）</td><td>极快（CPU 直接访问）</td></tr><tr><td><strong>可写次数</strong></td><td>有限（约 10k～100k 次）</td><td>无限</td></tr><tr><td><strong>在 STM32 中</strong></td><td>64KB Flash（地址 <code>0x08000000</code> 起）</td><td>20KB SRAM（地址 <code>0x20000000</code> 起）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>简单记</strong>：</p>
<ul>
<li><strong>Flash = 硬盘</strong> → 存程序、常量</li>
<li><strong>RAM = 内存条</strong> → 存运行时数据</li>
</ul>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="stm32-内存布局启动后">STM32 内存布局（启动后）<a href="#stm32-内存布局启动后" class="hash-link" aria-label="STM32 内存布局（启动后）的直接链接" title="STM32 内存布局（启动后）的直接链接">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">地址空间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────────┐ ← 0x08010000 (0x08000000 + 64KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        Flash          │ ← 程序代码、const 变量、字符串常量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  (Code + Constants)   │    如: &quot;Hello&quot;, const int x = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────────────────┘ ← 0x08000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────────┐ ← 0x08010000 (64KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   .rodata             │ ← 只读数据：const 变量、字符串字面量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   (Read-Only Data)    │    如: const char logo[] = {0x01,0x02,...};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       │         const int VERSION = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       │         &quot;Hello&quot;, &quot;Error: %d\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   .text               │ ← 程序代码（机器指令）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   (Code / Text)       │    所有函数的编译后二进制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   .init_array         │ ← C++ 全局构造函数表（C 项目通常为空）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   .ARM.exi / .ARM.ext │ ← 异常 unwind 表（用于异常回溯，C 项目可忽略）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Vector Table        │ ← 中断向量表（前 0x100～0x200 字节）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   (at 0x08000000)     │    包含初始栈顶（__initial_sp）、Reset_Handler 地址等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────────────────┘ ← 0x08000000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">（中间是外设寄存器等，略）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────────┐ ← 0x20005000 (0x20000000 + 20KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        SRAM           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        Stack          │ ← 主栈（main 函数及中断使用），向下增长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        Heap (可选)    │ ← 动态分配（malloc），向上增长</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Uninitialized Data  │ ← `.bss` 段：未初始化的全局/静态变量（如 int x;）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Initialized Data    │ ← `.data` 段：已初始化的全局/静态变量（如 int y = 10;）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────────────────┘ ← 0x20000000</span><br></span></code></pre></div></div>
<blockquote>
<p>⚠️ 注意：Stack 和 <code>.bss</code>/<code>.data</code> 之间<strong>没有隔离</strong>！栈溢出会覆盖全局变量。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="变量到底存在哪里">变量到底存在哪里？<a href="#变量到底存在哪里" class="hash-link" aria-label="变量到底存在哪里？的直接链接" title="变量到底存在哪里？的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-全局变量global-variables">1. 全局变量（Global Variables）<a href="#1-全局变量global-variables" class="hash-link" aria-label="1. 全局变量（Global Variables）的直接链接" title="1. 全局变量（Global Variables）的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> global_var </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// → .data 段（已初始化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> uninit_global</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// → .bss 段（未初始化，默认=0）</span><br></span></code></pre></div></div>
<ul>
<li>生命周期：整个程序运行期间</li>
<li>存储位置：RAM 的 <code>.data</code> 或 <code>.bss</code> 段</li>
<li>特点：地址固定，可被所有函数访问</li>
</ul>
<blockquote>
<p>其中，<code>.data</code> 段变量的初始值在程序烧录时存储于 Flash 的只读区域，系统启动时被复制到 RAM；而 <code>.bss</code> 段变量不占用 Flash 空间，启动时由启动代码将其对应的 RAM 区域清零。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-局部变量local-variables">2. 局部变量（Local Variables）<a href="#2-局部变量local-variables" class="hash-link" aria-label="2. 局部变量（Local Variables）的直接链接" title="2. 局部变量（Local Variables）的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> local_var </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// → 栈（Stack）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// → 栈（Stack）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li>生命周期：函数调用期间</li>
<li>存储位置：栈（Stack）</li>
<li>特点：<!-- -->
<ul>
<li>每次调用函数，就在栈上分配空间</li>
<li>函数返回时自动释放</li>
<li>栈空间有限！STM32 默认仅 1KB，可按需<a href="/docs/embedded/STM32/STM32F103C8T6#stm32-%E6%A0%88%E4%B8%8E%E5%A0%86%E5%88%86%E9%85%8D">分配</a></li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-加了-static-的变量">3. 加了 static 的变量<a href="#3-加了-static-的变量" class="hash-link" aria-label="3. 加了 static 的变量的直接链接" title="3. 加了 static 的变量的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-静态全局变量">(a) 静态全局变量<a href="#a-静态全局变量" class="hash-link" aria-label="(a) 静态全局变量的直接链接" title="(a) 静态全局变量的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> static_global </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// → .data 段</span><br></span></code></pre></div></div>
<ul>
<li>作用域限制在本文件（其他 .c 文件不可见）</li>
<li>存储位置：仍在 RAM 的 <code>.data</code>/<code>.bss</code> 段，和普通全局变量一样</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="b-静态局部变量">(b) 静态局部变量<a href="#b-静态局部变量" class="hash-link" aria-label="(b) 静态局部变量的直接链接" title="(b) 静态局部变量的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> static_local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">400</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// → .data 段（不是栈！）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li>生命周期：整个程序运行期间（只初始化一次）</li>
<li>存储位置：RAM 的 <code>.data</code>/<code>.bss</code> 段（不是栈！）</li>
<li>关键优势：不占用栈空间！</li>
</ul>
<blockquote>
<p>✅ 这就是为什么把函数中的 char buf[160] 改成 static 能缓解栈溢出！</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-常量constants">4. 常量（Constants）<a href="#4-常量constants" class="hash-link" aria-label="4. 常量（Constants）的直接链接" title="4. 常量（Constants）的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> CONST_VAR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// → Flash（.rodata 段）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// 字符串 &quot;Hello&quot; 在 Flash，指针在 RAM</span><br></span></code></pre></div></div>
<ul>
<li>存储位置：Flash（节省 RAM！）</li>
<li>注意：不能修改（否则触发硬件 fault）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="什么时候该用-static">什么时候该用 static？<a href="#什么时候该用-static" class="hash-link" aria-label="什么时候该用 static？的直接链接" title="什么时候该用 static？的直接链接">​</a></h4>
<table><thead><tr><th>场景</th><th style="text-align:center">是否推荐static</th><th>原因</th></tr></thead><tbody><tr><td>大缓冲区（&gt;100 字节）</td><td style="text-align:center">✅ 强烈推荐</td><td>避免栈溢出</td></tr><tr><td>仅在本文件使用的函数/变量</td><td style="text-align:center">✅ 推荐</td><td>隐藏实现，减少命名冲突</td></tr><tr><td>需要&quot;记忆&quot;上次值的局部变量</td><td style="text-align:center">✅ 必须用</td><td>如计数器、状态机</td></tr><tr><td>小整数、指针等（<code>&lt;16</code> 字节）</td><td style="text-align:center">❌ 不必</td><td>栈开销小，保持函数纯度更好</td></tr></tbody></table>
<blockquote>
<p>💡 嵌入式黄金法则：
“大数组不用局部，优先 static 或全局”</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="如何查看变量到底在哪">如何查看变量到底在哪？<a href="#如何查看变量到底在哪" class="hash-link" aria-label="如何查看变量到底在哪？的直接链接" title="如何查看变量到底在哪？的直接链接">​</a></h4>
<p>编译后查看 <code>.map 文件</code>（Keil 默认生成）：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.data section:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  global_var      0x20000000   Data          4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_global   0x20000004   Data          4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.bss section:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uninit_global   0x20000008   Zero Init     4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static_local    0x2000000C   Zero Init     4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stack size:      0x00000400   (1024 bytes)</span><br></span></code></pre></div></div>
<p>还能看到：</p>
<ul>
<li>各段大小</li>
<li>符号地址</li>
<li>最大栈使用估算（如果开启）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="总结一张表看懂变量存储">总结：一张表看懂变量存储<a href="#总结一张表看懂变量存储" class="hash-link" aria-label="总结：一张表看懂变量存储的直接链接" title="总结：一张表看懂变量存储的直接链接">​</a></h4>
<table><thead><tr><th>变量类型</th><th>示例</th><th>存储位置</th><th>生命周期</th><th>是否占栈</th></tr></thead><tbody><tr><td>全局变量</td><td><code>int x = 1;</code></td><td>RAM (.data)</td><td>整个程序</td><td>❌</td></tr><tr><td>未初始化全局</td><td><code>int y;</code></td><td>RAM (.bss)</td><td>整个程序</td><td>❌</td></tr><tr><td>局部变量</td><td><code>int z = 2;</code></td><td>栈 (Stack)</td><td>函数内</td><td>✅</td></tr><tr><td>大局部数组</td><td><code>char buf[200];</code></td><td>栈 (Stack)</td><td>函数内</td><td>✅（危险！）</td></tr><tr><td>static 局部</td><td><code>static int s = 3;</code></td><td>RAM (.data/.bss)</td><td>整个程序</td><td>❌</td></tr><tr><td>const 常量</td><td><code>const int c = 4;</code></td><td>Flash</td><td>整个程序</td><td>❌</td></tr><tr><td>字符串字面量</td><td><code>&quot;Hello&quot;</code></td><td>Flash</td><td>整个程序</td><td>❌</td></tr></tbody></table>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stm32-栈与堆分配">STM32 栈与堆分配<a href="#stm32-栈与堆分配" class="hash-link" aria-label="STM32 栈与堆分配的直接链接" title="STM32 栈与堆分配的直接链接">​</a></h3>
<blockquote>
<p>Keil 启动文件</p>
</blockquote>
<p></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-什么是栈stack和堆heap">🔹 什么是栈（Stack）和堆（Heap）？<a href="#-什么是栈stack和堆heap" class="hash-link" aria-label="🔹 什么是栈（Stack）和堆（Heap）？的直接链接" title="🔹 什么是栈（Stack）和堆（Heap）？的直接链接">​</a></h4>
<ul>
<li><strong>栈</strong>：用于函数调用、局部变量，<strong>从 SRAM 高地址向下增长</strong>（如 <code>0x20005000 →</code>）</li>
<li><strong>堆</strong>：用于 <code>malloc()</code>/<code>free()</code> 动态分配，<strong>从 <code>.bss</code> 后向上增长</strong></li>
<li><strong>全局/静态变量</strong>：存于 <code>.data</code> / <code>.bss</code>，位于 <strong>SRAM 低地址</strong></li>
</ul>
<blockquote>
<p>✅ 正确内存布局（高地址在上）：</p>
</blockquote>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x20005000 ──┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ Stack（向下 ⬇️）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ Heap（向上 ⬆️）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├───────────────</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ .bss / .data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x20000000 ──┘</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-何时需要修改">🔧 何时需要修改？<a href="#-何时需要修改" class="hash-link" aria-label="🔧 何时需要修改？的直接链接" title="🔧 何时需要修改？的直接链接">​</a></h4>
<table><thead><tr><th>场景</th><th>栈（Stack_Size）</th><th>堆（Heap_Size）</th></tr></thead><tbody><tr><td>简单控制（LED/按键）</td><td>❌ 几乎不用改</td><td>❌ 不用</td></tr><tr><td>通信协议（MQTT/HTTP）</td><td>✅ 必须改（大缓冲区）</td><td>⚠️ 若用 <code>malloc</code></td></tr><tr><td>图形显示（OLED/LCD）</td><td>✅ 常需改（局部缓存）</td><td>❌ 通常不用</td></tr><tr><td>RTOS / 文件系统</td><td>✅ 每任务独立栈</td><td>✅ 需要堆</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>经验</strong>：栈常需调整，堆只在明确使用动态分配时才开。</p>
</blockquote>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-如何判断是否需要改">🚨 如何判断是否需要改？<a href="#-如何判断是否需要改" class="hash-link" aria-label="🚨 如何判断是否需要改？的直接链接" title="🚨 如何判断是否需要改？的直接链接">​</a></h4>
<ul>
<li>
<p><strong>栈不足迹象</strong>：</p>
<ul>
<li>程序死机、HardFault</li>
<li>全局变量被莫名修改（如 OLED 显示乱码）</li>
<li>使用大局部数组（<code>char buf[200]</code>）后异常</li>
</ul>
</li>
<li>
<p><strong>堆不足迹象</strong>：</p>
<ul>
<li><code>malloc()</code> 返回 <code>NULL</code></li>
<li>动态分配失败但逻辑无误</li>
</ul>
</li>
</ul>
<blockquote>
<p>🔥 根本原因：<strong>栈溢出会覆盖 <code>.bss</code> 中的全局变量，造成“幽灵 bug”</strong></p>
</blockquote>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="️-推荐配置stm32f103c8t620kb-ram">⚙️ 推荐配置（STM32F103C8T6，20KB RAM）<a href="#️-推荐配置stm32f103c8t620kb-ram" class="hash-link" aria-label="⚙️ 推荐配置（STM32F103C8T6，20KB RAM）的直接链接" title="⚙️ 推荐配置（STM32F103C8T6，20KB RAM）的直接链接">​</a></h4>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Stack_Size    EQU     0x00001000   ; 4KB —— 安全默认值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Heap_Size     EQU     0x00000200   ; 512B —— 谨慎预留（见说明</span><br></span></code></pre></div></div>
<p><strong>为什么 4KB？</strong><br>
<!-- -->足够应对深层函数调用、协议栈（如 MQTT/HTTP）、局部大数组等常见场景。</p>
<p><strong>为什么保留 512B 堆？</strong></p>
<ul>
<li>即使未显式调用 <code>malloc()</code>，某些 C 库函数（如 <code>sprintf</code> with <code>%f</code>）或第三方库可能隐式使用堆</li>
<li>若确认使用 <strong>MicroLIB</strong> 且完全无动态分配，可设为 <code>0x000</code></li>
<li>512B 仅占 2.5% RAM，却能避免隐蔽崩溃，<strong>推荐作为安全余量</strong></li>
</ul>
<p>✅ <strong>激进点？</strong><br>
<!-- -->即使设为 8KB 栈（<code>0x2000</code>），只要总用量 &lt; 20KB，依然安全！</p>
<p>⚠️ <strong>注意事项</strong></p>
<ul>
<li>栈 + 堆 + 全局变量 ≤ 20KB</li>
<li>栈太小 → 溢出 → 覆盖全局变量（如 OLED 缓存乱码）</li>
<li>栈太大 → 挤占全局变量空间（但比溢出更安全）</li>
<li>不要盲目保留默认 512B 堆而不思考用途，也不要武断关闭堆而不验证依赖</li>
</ul>
<p>🔍 <strong>实用技巧</strong></p>
<ul>
<li>查看 <code>.map</code> 文件：确认各段实际地址与大小</li>
<li><strong>口诀</strong>：<br>
<!-- -->“全局在底，堆往上走，栈在顶头，往下开口。”</li>
</ul>
<p>💡 <strong>核心原则</strong>：<br>
<!-- -->在资源允许下，栈“宁大勿小”；堆“按需预留，不用可关”。<br>
<!-- -->主动规划内存，是写出健壮嵌入式系统的第一步。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="遇到的问题">遇到的问题<a href="#遇到的问题" class="hash-link" aria-label="遇到的问题的直接链接" title="遇到的问题的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="栈溢出导致oled显示乱码">栈溢出导致OLED显示乱码<a href="#栈溢出导致oled显示乱码" class="hash-link" aria-label="栈溢出导致OLED显示乱码的直接链接" title="栈溢出导致OLED显示乱码的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-问题现象">🎯 问题现象<a href="#-问题现象" class="hash-link" aria-label="🎯 问题现象的直接链接" title="🎯 问题现象的直接链接">​</a></h4>
<p>在开发基于 <strong>STM32F103C8T6 + SSD1306 OLED（128×64）</strong> 的物联网设备时，我设计了如下显示布局：</p>
<ul>
<li><strong>左侧（X=0～63）</strong>：固定显示启动 Logo</li>
<li><strong>右侧（X=66～127）</strong>：动态显示初始化状态（DHT11、ESP8266、OneNET 连接进度）</li>
</ul>
<p>预期行为：<strong>在调用 <code>OLED_Clear()</code> 前，Logo 应始终保持不变</strong>。</p>
<p>但实际运行中：</p>
<ul>
<li>✅ DHT11、ESP8266 阶段：Logo 正常</li>
<li>❌ 执行到 OneNET MQTT 连接阶段：<strong>左侧 Logo 出现乱码</strong></li>
</ul>
<p>更诡异的是：</p>
<ul>
<li><code>OneNet_DevLink()</code> <strong>前</strong> 显示 <code>&quot;Test0&quot;</code> → Logo 正常</li>
<li><code>OneNet_DevLink()</code> <strong>后</strong> 显示 <code>&quot;Test1&quot;</code> → Logo 乱码</li>
<li>若在 <code>&quot;Test1&quot;</code> 前<strong>重绘 Logo</strong>（<code>OLED_Clear()</code> + <code>OLED_ShowImageArea</code>），则显示正常</li>
</ul>
<p>→ <strong>Logo 数据被意外修改，但非 OLED 驱动逻辑错误</strong>。</p>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-排查过程与关键线索">🔍 排查过程与关键线索<a href="#-排查过程与关键线索" class="hash-link" aria-label="🔍 排查过程与关键线索的直接链接" title="🔍 排查过程与关键线索的直接链接">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="第一步排除驱动问题">第一步：排除驱动问题<a href="#第一步排除驱动问题" class="hash-link" aria-label="第一步：排除驱动问题的直接链接" title="第一步：排除驱动问题的直接链接">​</a></h4>
<ul>
<li>确认 <code>OLED_ClearArea(66, 0, 62, 63)</code> 不覆盖 X=0～63</li>
<li>检查 <code>OLED_ShowString</code> 无越界写入</li>
<li>前期阶段正常 → 驱动基本可靠</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="第二步定位触发点">第二步：定位触发点<a href="#第二步定位触发点" class="hash-link" aria-label="第二步：定位触发点的直接链接" title="第二步：定位触发点的直接链接">​</a></h4>
<p>通过测试字符串缩小范围：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">OLED_ShowString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">66</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Test0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Logo 正常</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">OneNet_DevLink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                      </span><span class="token comment" style="color:#999988;font-style:italic">// ← 关键函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">OLED_ShowString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">66</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Test1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Logo 乱码</span><br></span></code></pre></div></div>
<p>深入发现，问题出现在：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">OneNET_Authorization</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> authorization_buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">authorization_buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="第三步变量存储类型实验关键突破">第三步：变量存储类型实验（关键突破！）<a href="#第三步变量存储类型实验关键突破" class="hash-link" aria-label="第三步：变量存储类型实验（关键突破！）的直接链接" title="第三步：变量存储类型实验（关键突破！）的直接链接">​</a></h4>
<p>将局部数组：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> authorization_buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">160</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>改为：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> authorization_buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">160</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>结果：<strong>Logo 依然乱码，但乱码图案发生变化！</strong></p>
<p>→ 这一现象强烈暗示：<strong>内存布局改变影响了数据破坏位置——典型的内存踩踏（Memory Corruption）。</strong></p>
<blockquote>
<p>💡 注：排查中曾遇 Flash 超限报错（L6220E: LR_IROM1 size exceeds limit），但此为代码体积问题，<strong>与本次 RAM 污染无关</strong>，仅是优化提醒。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-根本原因栈溢出覆盖全局变量">🧠 根本原因：栈溢出覆盖全局变量<a href="#-根本原因栈溢出覆盖全局变量" class="hash-link" aria-label="🧠 根本原因：栈溢出覆盖全局变量的直接链接" title="🧠 根本原因：栈溢出覆盖全局变量的直接链接">​</a></h4>
<p>综合所有线索，真相浮出水面：</p>
<blockquote>
<p><code>OneNET_Authorization</code> 及其调用链使用大量局部变量（160 字节缓冲区 + 协议栈临时数据），导致 <strong>栈空间耗尽，向下溢出并覆盖了位于 RAM 低地址的全局变量</strong> <code>OLED_DisplayBuf</code>。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="内存布局分析来自-map-文件">内存布局分析（来自 .map 文件）<a href="#内存布局分析来自-map-文件" class="hash-link" aria-label="内存布局分析（来自 .map 文件）的直接链接" title="内存布局分析（来自 .map 文件）的直接链接">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x20002BF0 ──┐ ← 初始栈顶（__initial_sp）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             │ Stack（2KB，向下增长 ⬇️）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x200023F0 ──┤ ← 栈理论底部</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             │ （空隙仅 140 字节！）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x200021F0 ──┤ ← Heap（512B，向上增长 ⬆️）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x20002164 ──┤ ← .bss 段结束</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             │ OLED_DisplayBuf[1024]（位于 .bss 末尾！）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x20001D64 ──┘ ← .bss 起始附近</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="为什么发生覆盖">为什么发生覆盖？<a href="#为什么发生覆盖" class="hash-link" aria-label="为什么发生覆盖？的直接链接" title="为什么发生覆盖？的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OneNet_DevLink</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> authorization_buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">160</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 占用栈</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ... 其他局部变量 + 深层函数调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 总栈使用 &gt; 2KB → 溢出！</span><br></span></code></pre></div></div>
<p>→ 栈向下增长，覆盖 .bss 末尾的：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">uint8_t</span><span class="token plain"> OLED_DisplayBuf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 全局变量</span><br></span></code></pre></div></div>
<p>→ Logo 数据被破坏 → 乱码。
而改为 <code>static</code> 后：</p>
<ul>
<li>不占栈，缓解压力</li>
<li>但改变了 <code>.bss</code> 布局 → 覆盖位置偏移 → 乱码图案变化</li>
</ul>
<blockquote>
<p>⚠️ 注意：函数返回后栈指针恢复，但被污染的全局变量<strong>无法自动修复</strong>！</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-以为是20kb-ram-不足">📊 以为是“20KB RAM 不足”？<a href="#-以为是20kb-ram-不足" class="hash-link" aria-label="📊 以为是“20KB RAM 不足”？的直接链接" title="📊 以为是“20KB RAM 不足”？的直接链接">​</a></h4>
<p>不然：</p>
<table><thead><tr><th>项目</th><th>大小</th></tr></thead><tbody><tr><td>全局变量（.bss）</td><td>～8.3 KB</td></tr><tr><td>堆（Heap）</td><td>512 B（可关闭）</td></tr><tr><td>原栈（Stack）</td><td><strong>2 KB（配额不足！）</strong></td></tr><tr><td>总计已用</td><td><strong>≈10.8 KB</strong></td></tr><tr><td>剩余 RAM</td><td><strong>≈9.2 KB</strong></td></tr><tr><td><strong>✅ 系统远未达内存瓶颈，问题纯粹是栈配额不合理！</strong></td><td>这是分配<a href="/docs/embedded/STM32/STM32F103C8T6#stm32-%E6%A0%88%E4%B8%8E%E5%A0%86%E5%88%86%E9%85%8D">方法</a>！</td></tr></tbody></table>
<p>对 MQTT/HTTP/JSON 等协议栈项目，<strong>分配 8KB 栈完全合理</strong>：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">全局变量： ～8.3 KB  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">堆（关闭）： 0 KB  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">栈（8KB）： 8 KB  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">──────────────────  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">总计： ～16.3 KB &lt; 20 KB ✅</span><br></span></code></pre></div></div>
<blockquote>
<p>🔑 关键澄清：<code>Stack_Size = 0x2000</code>（8KB）仅预留地址空间，<strong>实际栈按需增长，未使用部分不占资源</strong>。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-解决方案与工程建议">✅ 解决方案与工程建议<a href="#-解决方案与工程建议" class="hash-link" aria-label="✅ 解决方案与工程建议的直接链接" title="✅ 解决方案与工程建议的直接链接">​</a></h4>
<p><strong>方案 1：增大栈空间（推荐）</strong>
在 <code>startup_stm32f103xb.s</code> 中：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Stack_Size    EQU     0x00002000   ; 8KB —— 安全余量充足</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Heap_Size     EQU     0x00000000   ; 关闭堆（裸机通常不用 malloc）</span><br></span></code></pre></div></div>
<p><strong>优势</strong>：</p>
<ul>
<li>彻底杜绝栈溢出</li>
<li>支持复杂协议栈</li>
<li>未来扩展无忧</li>
</ul>
<p><strong>方案 2：大缓冲区改 <code>static</code>（临时验证）</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 危险：占用栈</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">char buf[160];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 安全：放 .bss 段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static char buf[160];</span><br></span></code></pre></div></div>
<blockquote>
<p>优点：快速验证；注意：非线程安全（裸机通常无此问题）</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="长期规范">长期规范<a href="#长期规范" class="hash-link" aria-label="长期规范的直接链接" title="长期规范的直接链接">​</a></h4>
<ul>
<li>禁止函数内定义 &gt;100 字节数组</li>
<li>避免递归调用</li>
<li>关键全局变量尽量放 RAM 低地址（通过链接脚本控制）</li>
<li>定期检查 .map 文件中的内存布局</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-写在最后">💡 写在最后<a href="#-写在最后" class="hash-link" aria-label="💡 写在最后的直接链接" title="💡 写在最后的直接链接">​</a></h4>
<p>这次调试让我深刻体会到：</p>
<blockquote>
<p>“实现功能是最简单的一步，难的是后续的优化和调试。”
这个“Logo 乱码”问题，表面是显示异常，实则是<strong>系统资源管理缺失的警钟</strong>。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-快速自查清单">🔍 快速自查清单<a href="#-快速自查清单" class="hash-link" aria-label="🔍 快速自查清单的直接链接" title="🔍 快速自查清单的直接链接">​</a></h4>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->是否有函数内定义大数组（&gt;100 字节）？</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->是否使用了协议栈（MQTT/HTTP/JSON）？</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Logo 或关键数据是否在复杂操作后异常？</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->改为 <code>static</code> 后 bug 行为是否改变？</li>
</ul>
<p>→ 若多个答案为“是”，<strong>优先怀疑栈溢出</strong>！</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于keil的使用">关于Keil的使用<a href="#关于keil的使用" class="hash-link" aria-label="关于Keil的使用的直接链接" title="关于Keil的使用的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="keil内存映射配置">Keil内存映射配置<a href="#keil内存映射配置" class="hash-link" aria-label="Keil内存映射配置的直接链接" title="Keil内存映射配置的直接链接">​</a></h3>
<p>这里的配置</p>
<p></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-romflash64kb">🔹 ROM（Flash，64KB）<a href="#-romflash64kb" class="hash-link" aria-label="🔹 ROM（Flash，64KB）的直接链接" title="🔹 ROM（Flash，64KB）的直接链接">​</a></h4>
<ul>
<li><strong>物理范围</strong>：<code>0x08000000 ～ 0x08010000</code>（共 64KB）</li>
<li><strong>Keil ROM Size</strong>： 默认设为 <code>0x10000</code>（65536 字节）</li>
<li><strong>ROM用途</strong>：存放代码（<code>.text</code>）、常量（<code>.rodata</code>）、中断向量表</li>
<li><strong>可改为 <code>0xFC00</code></strong>，后续的空间给用户数据存储（如掉电保存参数），储存范围是<code>0x0800FC00 ～ 0x08010000</code></li>
<li>✅ <strong>建议</strong>：若使用 Flash 存储功能，则将Size改为 <code>0xFC00</code>；否则可改满为0x10000。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-ramsram20kb">🔹 RAM（SRAM，20KB）<a href="#-ramsram20kb" class="hash-link" aria-label="🔹 RAM（SRAM，20KB）的直接链接" title="🔹 RAM（SRAM，20KB）的直接链接">​</a></h4>
<ul>
<li><strong>物理范围</strong>：<code>0x20000000 ～ 0x20005000</code>（共 20KB）</li>
<li><strong>Keil 可调小 Size（如 18KB）</strong><br>
<!-- -->→ 仅在需要预留 RAM 给 DMA、USB 缓冲区等特殊用途时才缩小</li>
<li><strong>日常开发应保持 <code>0x5000</code>（20KB）</strong>，以充分利用资源、避免意外溢出</li>
<li>✅ <strong>建议</strong>：无特殊需求？不要调小 RAM！</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-核心原则">🧠 核心原则<a href="#-核心原则" class="hash-link" aria-label="🧠 核心原则的直接链接" title="🧠 核心原则的直接链接">​</a></h4>
<ul>
<li>配置不是“能不能”，而是“为什么”</li>
<li>Flash/RAM 的起止地址和大小，是硬件与软件协同设计的关键边界</li>
<li>预留空间 = 主动规划，不是浪费</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="keil-中-use-microlib">Keil 中 Use MicroLIB<a href="#keil-中-use-microlib" class="hash-link" aria-label="Keil 中 Use MicroLIB的直接链接" title="Keil 中 Use MicroLIB的直接链接">​</a></h3>
<blockquote>
<p>——嵌入式 Flash 优化的关键技巧</p>
</blockquote>
<p>在 STM32 裸机开发中，<strong>勾选 <code>Use MicroLIB</code> 可能会将 Flash 占用从 60KB 直接降至 52KB</strong>！</p>
<p></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-一句话总结">🔥 一句话总结<a href="#-一句话总结" class="hash-link" aria-label="🔥 一句话总结的直接链接" title="🔥 一句话总结的直接链接">​</a></h4>
<blockquote>
<p>当做 <strong>无 OS 的裸机开发</strong>，且 <strong>不使用文件 I/O、浮点 <code>printf</code>、多线程</strong> 时，<strong>务必启用 MicroLIB</strong>。它用极简 C 运行时库替代默认庞大标准库，大幅减小体积。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-microlib-vs-默认-c-库">✅ MicroLIB vs 默认 C 库<a href="#-microlib-vs-默认-c-库" class="hash-link" aria-label="✅ MicroLIB vs 默认 C 库的直接链接" title="✅ MicroLIB vs 默认 C 库的直接链接">​</a></h4>
<table><thead><tr><th>特性</th><th>默认 ARM C Library</th><th>MicroLIB</th></tr></thead><tbody><tr><td>体积</td><td><code>&gt;10 KB</code></td><td><code>&lt;2 KB</code></td></tr><tr><td>功能</td><td>完整（<code>fopen</code>, <code>%f</code>, <code>errno</code>, 多线程安全）</td><td>仅基础（<code>memcpy</code>, <code>sprintf</code> 整数版）</td></tr><tr><td>重入性</td><td>可重入（支持 RTOS）</td><td><strong>不可重入</strong>（仅单线程安全）</td></tr><tr><td>浮点 <code>printf</code></td><td>支持 <code>%f</code>（但占 5–8KB）</td><td>❌ 不支持（输出 <code>???</code>）</td></tr><tr><td>文件 I/O</td><td>支持</td><td>❌ 不支持</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-何时使用">✅ 何时使用？<a href="#-何时使用" class="hash-link" aria-label="✅ 何时使用？的直接链接" title="✅ 何时使用？的直接链接">​</a></h4>
<ul>
<li><strong>✅ 推荐</strong>：STM32 裸机项目（如传感器 + OLED + 串口通信）</li>
<li><strong>❌ 禁止</strong>：<!-- -->
<ul>
<li>使用 FreeRTOS 且多任务调用 <code>printf</code>/<code>malloc</code></li>
<li>必须使用 <code>printf(&quot;%f&quot;, val)</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>💡 替代浮点打印：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3.1415</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%d.%02d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 输出 &quot;3.14&quot;</span><br></span></code></pre></div></div>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="️-如何启用">⚙️ 如何启用？<a href="#️-如何启用" class="hash-link" aria-label="⚙️ 如何启用？的直接链接" title="⚙️ 如何启用？的直接链接">​</a></h4>
<ol>
<li><strong>Options for Target → Target</strong></li>
<li>勾选 <strong>✅ Use MicroLIB</strong></li>
<li>确保代码中 <strong>无 <code>%f</code>、无 <code>fopen</code>、无 <code>errno</code></strong></li>
</ol>
<blockquote>
<p>启动文件通常已提供 <code>__user_setup_stackheap()</code>，无需额外实现。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-为何节省-8kb">📊 为何节省 8KB+？<a href="#-为何节省-8kb" class="hash-link" aria-label="📊 为何节省 8KB+？的直接链接" title="📊 为何节省 8KB+？的直接链接">​</a></h4>
<p>默认库为“通用性”链接了大量未用功能：</p>
<ul>
<li>浮点 <code>printf</code>：5–8 KB → MicroLIB 仅 0.5 KB</li>
<li><code>malloc</code>/<code>exit</code>/<code>locale</code>/文件 stubs：共 ～3 KB → 全移除</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-最佳实践">✅ 最佳实践<a href="#-最佳实践" class="hash-link" aria-label="✅ 最佳实践的直接链接" title="✅ 最佳实践的直接链接">​</a></h4>
<ul>
<li>所有裸机项目 <strong>默认开启 MicroLIB</strong></li>
<li><strong>禁止使用 <code>%f</code></strong>（建立代码规范）</li>
<li>避免 <code>malloc</code>，优先静态缓冲区</li>
<li>定期检查 <code>.map</code> 文件，确认无 <code>_sys_open</code>、<code>_printf_fp</code> 等 full lib 符号</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="杂记">杂记<a href="#杂记" class="hash-link" aria-label="杂记的直接链接" title="杂记的直接链接">​</a></h2>
<ol>
<li>STM32启动顺序</li>
</ol>
<blockquote>
<p>STM32 上电后先执行芯片厂商提供的汇编启动代码（Reset_Handler），完成栈初始化、.data/.bss 段设置和时钟配置后，才跳转到 main() 函数，并非直接从 main 开始。</p>
</blockquote><div class="doc-comments-wrapper" style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--ifm-color-emphasis-300)"><div style="margin-top:2rem"><div style="min-height:200px">加载评论中...</div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/EurekaShadow/EurekaShadow.github.io/tree/master/docs/embedded/STM32/STM32F103C8T6.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">最后<!-- -->由 <b>EurekaShadow</b> <!-- -->于 <b><time datetime="2026-01-18T15:54:15.000Z" itemprop="dateModified">2026年1月18日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/嵌入式相关"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">嵌入式相关</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/embedded/博客相关/embedded-resources"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">博客资源索引</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#概念理解" class="table-of-contents__link toc-highlight">概念理解</a><ul><li><a href="#mcu-内存结构与变量存储详解" class="table-of-contents__link toc-highlight">MCU 内存结构与变量存储详解</a></li><li><a href="#stm32-栈与堆分配" class="table-of-contents__link toc-highlight">STM32 栈与堆分配</a></li></ul></li><li><a href="#遇到的问题" class="table-of-contents__link toc-highlight">遇到的问题</a><ul><li><a href="#栈溢出导致oled显示乱码" class="table-of-contents__link toc-highlight">栈溢出导致OLED显示乱码</a></li></ul></li><li><a href="#关于keil的使用" class="table-of-contents__link toc-highlight">关于Keil的使用</a><ul><li><a href="#keil内存映射配置" class="table-of-contents__link toc-highlight">Keil内存映射配置</a></li><li><a href="#keil-中-use-microlib" class="table-of-contents__link toc-highlight">Keil 中 Use MicroLIB</a></li></ul></li><li><a href="#杂记" class="table-of-contents__link toc-highlight">杂记</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">记录</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/mydoc/testpage0">模板</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/3546860773968305" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bilibili<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/EurekaShadow" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">博客</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>