---
slug: Algolia
title: 为 Docusaurus 添加 Algolia 搜索功能
authors: eurekaX
tags: [Algolia,Search,搜索]
---

import { Highlight, Keyword, Light, B1, B2, B3, BH3, B3W, MyColor} from '@site/src/components/ForMDX';
import CardImg from '@site/src/components/CardImg';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

本文介绍使用 Algolia 为 Docusaurus 网站添加搜索功能。

<!-- truncate -->


## <B2> 配置 Algolia 教程 🔎</B2>

我参考了这篇[文章](https://www.alanwang.site/posts/blog-guides/docusaurus-search)为我的网站添加了搜索功能。但是在实践过程中遇到了一些问题，原文章说明也不够详细，因此决定写一篇更加详细的博客来记录整个配置过程。


## 获取 Algolia API

本小节的目标是获取 `Algolia` 的这三个 `API`：
```
1. Application ID
2. Search API Key
3. Admin API Key
``` 
### API 名称对应关系
`Algolia`中 的 `API` 名称和代码中的名称并**不完全一致**，对应关系如下：
```js title="docusaurus.config.js"
Application ID -> appId
Search API Key -> apiKey
```
```js title="Actions secrets"
Application ID -> ALGOLIA_APP_ID
Admin API Key -> ALGOLIA_API_KEY
```


### 注册 Algolia 账户
1. 打开 [Algolia官网](https://www.algolia.com/ "Algolia") ，使用Github账号注册并登录
<p><CardImg src="/img/Blog/Algolia1.jpg" alt="Algolia1" isCenter={true} isBoxed={true} /></p>

2. 点击 `Not now ...` 跳过初始设置
<p><CardImg src="/img/Blog/Algolia2.jpg" alt="Algolia2" isCenter={true} isBoxed={true} /></p>

### 获取 API
1. 打开 `Settings` 配置页面
<p><CardImg src="/img/Blog/Algolia3.jpg" alt="Algolia3" isCenter={true} isBoxed={true} /></p>

2. 查看API Key
<p><CardImg src="/img/Blog/Algolia4.jpg" alt="Algolia4" isCenter={true} isBoxed={true} /></p>

<p><CardImg src="/img/Blog/Algolia5.jpg" alt="Algolia5" isCenter={true} isBoxed={true} /></p>

上面三个 `API` 即为所需，此页面可保持打开，方便后续复制粘贴。 至此，三个 `API` 应已成功获取。
:::danger[重要提醒]
不要分享 **Admin API Key！** 这是敏感信息，泄露可能导致安全问题。！
:::

<details>
<summary>只找到两个 API ?</summary>

如果在查看 `API` 的时候看到**只有两个** `API`，分别是 `Application ID` 和 `Search API Key`，没有 `Admin API Key` ？！那说明刚才没有严格按照这个[步骤](./Algolia#注册-algolia-账户 )走，现在看到的是`Algolia` 默认创建的 Application `Docsearch` 。该 Application 暂时是没有密钥的。（按官方的教程一步步走应该会有，但我没试过。🥱）解决方法是再创建一个 Application，在这里：`Settings/API Keys`
<p><CardImg src="/img/Blog/Algolia26.jpg" alt="Algolia26" isCenter={true} isBoxed={true} /></p>

填上名称后，其他配置保持默认，直接点击 `Next:Review & Confirm` -> `Create Application`。新Application 的 `API` 获取方式与上面一样。

</details>

## 创建 Actions Secrets
1. 打开存放网站项目代码的 Github 仓库，进入：`Settings/Secrets and variables/Actions`。

<p><CardImg src="/img/Blog/Algolia8.jpg" alt="Algolia8" isCenter={true} isBoxed={true} /></p>

2. 返回 Algolia 页面，复制 `Application ID`：
<p><CardImg src="/img/Blog/Algolia9.jpg" alt="Algolia9" isCenter={true} isBoxed={true} /></p>

3. 返回 Github 页面，填上名称 `ALGOLIA_APP_ID`，粘贴秘钥，点击 `Add secret`。
<p><CardImg src="/img/Blog/Algolia11.jpg" alt="Algolia10" isCenter={true} isBoxed={true} /></p>

4. 返回 Algolia 页面，复制 `Admin API Key`：
<p><CardImg src="/img/Blog/Algolia12.jpg" alt="Algolia11" isCenter={true} isBoxed={true} /></p>

5. 返回 Github 页面，填上名称 `ALGOLIA_API_KEY`，粘贴秘钥，点击 `Add secret`。
<p><CardImg src="/img/Blog/Algolia13.jpg" alt="Algolia12" isCenter={true} isBoxed={true} /></p>

6. 预期结果：
<p><CardImg src="/img/Blog/Algolia14.jpg" alt="Algolia14" isCenter={true} isBoxed={true} /></p>

## 创建 Github Actions workflow
* 可以在本地项目根目录下创建 `.github/workflows/docsearch.yml` 文件：
<p><CardImg src="/img/Blog/Algolia6.jpg" alt="Algolia6" isCenter={true} isBoxed={true} /></p>

```yml title=".github/workflows/docsearch.yml"
name: DocSearch Scraper

# 定义工作流触发条件
on:
  # 允许手动触发工作流
  workflow_dispatch:
  # 自动运行 (UTC时间)
  schedule:
    - cron: '0 0 * * *'

# 定义工作流任务
jobs:
  algolia:
    # 运行环境
    runs-on: ubuntu-latest
    steps:
      # 检出代码仓库
      - uses: actions/checkout@v3

      # 安装 jq 工具用于处理 JSON
      - name: Install jq
        run: sudo apt-get install jq

      # 验证配置文件是否存在
      - name: Validate docsearch.json exists
        run: |
          if [ ! -f "docsearch.json" ]; then
            echo "docsearch.json not found!"
            exit 1
          fi

      # 读取并设置 Algolia 配置
      - name: Get the content of docsearch.json as config
        id: algolia_config
        run: echo "config=$(cat docsearch.json | jq -r tostring)" >> $GITHUB_OUTPUT

      # 运行 DocSearch 爬虫
      - name: Run algolia/docsearch-scraper image
        env:
          # 从 secrets 获取 Algolia 凭据
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
          CONFIG: ${{ steps.algolia_config.outputs.config }}
        run: |
          echo "Starting DocSearch scraper..."
          docker run \
            --env APPLICATION_ID=${ALGOLIA_APP_ID} \
            --env API_KEY=${ALGOLIA_API_KEY} \
            --env "CONFIG=${CONFIG}" \
            algolia/docsearch-scraper
          echo "DocSearch scraper completed successfully."
```

如果想配置成**部署完成后**便触发该工作流，可以参考这篇[文章](https://www.alanwang.site/posts/blog-guides/docusaurus-search#%E5%88%9B%E5%BB%BA-github-actions )。但我觉得手动和定时触发已经完全足够，因此没有尝试其他触发方式。

## 创建 docsearch.json

<p><CardImg src="/img/Blog/Algolia15.jpg" alt="Algolia15" isCenter={true} isBoxed={true} /></p>

下面黄色高亮部分需要改成自己的配置，`index_name`可自定义，但要和后续的`docusaurus.config.js`配置一致，`start_urls`和`sitemap_urls`改成自己的链接。
```json title="docsearch.json"
{
   // highlight-start
  "index_name": "test-site",
  "start_urls": ["https://www.eurekashadow.xin/"],
  "sitemap_urls": ["https://www.eurekashadow.xin/sitemap.xml"],
  // highlight-end
  // highlight-add-start
  "js_render": true,
  "js_wait": 1,
  // highlight-add-end
  "selectors": {
    "lvl0": {
      "selector": "(//ul[contains(@class,'menu__list')]//a[contains(@class, 'menu__link menu__link--sublist menu__link--active')]/text() | //nav[contains(@class, 'navbar')]//a[contains(@class, 'navbar__link--active')]/text())[last()]",
      "type": "xpath",
      "global": true,
      "default_value": "Documentation"
    },
    "lvl1": "header h1, article h1",
    "lvl2": "article h2",
    "lvl3": "article h3",
    "lvl4": "article h4",
    "lvl5": "article h5, article td:first-child",
    "lvl6": "article h6",
    "text": "article p, article li, article td:last-child"
  },
  "custom_settings": {
    "attributesForFaceting": ["type", "lang", "language", "version", "docusaurus_tag"],
    "attributesToRetrieve": ["hierarchy", "content", "anchor", "url", "url_without_anchor", "type"],
    "attributesToHighlight": ["hierarchy", "content"],
    "attributesToSnippet": ["content:10"],
    "camelCaseAttributes": ["hierarchy", "content"],
    "searchableAttributes": [
      "unordered(hierarchy.lvl0)",
      "unordered(hierarchy.lvl1)",
      "unordered(hierarchy.lvl2)",
      "unordered(hierarchy.lvl3)",
      "unordered(hierarchy.lvl4)",
      "unordered(hierarchy.lvl5)",
      "unordered(hierarchy.lvl6)",
      "content"
    ],
    "distinct": true,
    "attributeForDistinct": "url",
    "customRanking": ["desc(weight.pageRank)", "desc(weight.level)", "asc(weight.position)"],
    "ranking": ["words", "filters", "typo", "attribute", "proximity", "exact", "custom"],
    "highlightPreTag": "<span class='algolia-docsearch-suggestion--highlight'>",
    "highlightPostTag": "</span>",
    "minWordSizefor1Typo": 3,
    "minWordSizefor2Typos": 7,
    "allowTyposOnNumericTokens": false,
    "minProximity": 1,
    "ignorePlurals": true,
    "advancedSyntax": true,
    "attributeCriteriaComputedByMinProximity": true,
    "removeWordsIfNoResults": "allOptional",
    "separatorsToIndex": "_",
    "synonyms": [
      ["js", "javascript"],
      ["ts", "typescript"]
    ]
  }
}
```
> 注意：绿色标注的两行配置（js_render 和 js_wait）**非常重要**。没有这两句的话，Algolia可能只能爬取到网站首页的数据。在除首页外的页面点击F12，可能会发现404页面，但此时网页是可以正常显示的。这种显示和源码不一致的情况导致无法爬取到完整数据。加上这两句表示渲染完成后再爬取，如此便能正常获取所有数据。


## 配置 docusaurus.config.js
1. 位置示意：
<p><CardImg src="/img/Blog/Algolia16.jpg" alt="Algolia16" isCenter={true} isBoxed={true} /></p>

2. 新增代码：
```js title="docusaurus.config.js"
//添加Algolia搜索
algolia: {
    // Application ID
    appId: '********',
    //  Search API Key
    apiKey: '*******************',
    indexName: 'test-site',//与docsearch.json中的index_name一致
    searchPagePath: 'search',
    contextualSearch: true
    },
```
[不记得名称对应关系？](./Algolia#api-名称对应关系 )



## 网站部署
* 将代码 `git push` 到远端仓库中。
<p><CardImg src="/img/Blog/Algolia18.jpg" alt="Algolia18" isCenter={true} isBoxed={true} /></p>

## 手动触发工作流爬取信息

* 在Vercel部署已经完成的情况下，回到GitHub仓库中，点击Actions，选择Docsearch scraper，点击Run workflow，即可触发该工作流，爬取网站信息并生成索引文件用于后续Algolia搜索。
<p><CardImg src="/img/Blog/Algolia19.jpg" alt="Algolia19" isCenter={true} isBoxed={true} /></p>

* 运行完毕：
<p><CardImg src="/img/Blog/Algolia20.jpg" alt="Algolia20" isCenter={true} isBoxed={true} /></p>

## 查看 Algolia 记录
1. 点击 `Data Source`
<p><CardImg src="/img/Blog/Algolia21.jpg" alt="Algolia21" isCenter={true} isBoxed={true} /></p>

2. 点击 `indices`，从下图可知索引文件已经生成，在索引 `test-site` 下一共找到了 `134`个记录。这个记录数量取决于网站内容，如果内容多，记录也多。我这个只是演示网站，只有134记录，正常的索引记录可能会有几千甚至上万个。

> 注意，只有这里出现了和你**网站内容所匹配的记录**时，才表示**配置成功**。如果网站内容很多，结果这里的记录只有寥寥几条，那明显是某个地方出错了。可能是[这里](./Algolia#创建-docsearchjson)的两行没有加？
<p><CardImg src="/img/Blog/Algolia22.jpg" alt="Algolia22" isCenter={true} isBoxed={true} /></p>

## 将网站部署到GitPages
> 其实在本地就可以查看结果了，部署再看是为了进一步确认结果是否正确。毕竟有的时候本地运行的好好的，但是部署到GitPages的时候，就出现了问题。（说的就是你！i18n，坑爹的现在闪烁问题还没能解决。。。😑）
<p><CardImg src="/img/Blog/Algolia23.jpg" alt="Algolia23" isCenter={true} isBoxed={true} /></p>

* 部署完成：
<p><CardImg src="/img/Blog/Algolia24.jpg" alt="Algolia24" isCenter={true} isBoxed={true} /></p>

## 结果
大功告成！现在网站可以使用搜索功能了！🎉
<p><CardImg src="/img/Gif/gif-example.gif" alt="AlgoliaResult" isCenter={true} isBoxed={true} /></p>

这个过程还挺曲折的，多亏了下面的参考资料，没有他的文章参考，我怕是难以完成这个搜索功能。但即使有参考，也并非一蹴而就的，为了实现这个搜索功能，我花了很多时间，也走了很多弯路，希望这个总结能帮助到有缘之人。（也可能是未来的自己？🥱）

## 📚 参考资料

[1]. [AlanWang's Blog](https://www.alanwang.site/posts/blog-guides/docusaurus-search "学习")

